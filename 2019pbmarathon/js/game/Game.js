"use strict";function _classCallCheck(e,a){if(!(e instanceof a))throw new TypeError("Cannot call a class as a function")}function _defineProperties(e,a){for(var t=0;t<a.length;t++){var r=a[t];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function _createClass(e,a,t){return a&&_defineProperties(e.prototype,a),t&&_defineProperties(e,t),e}var Game=function(){function a(e){var t=this;_classCallCheck(this,a),this.ratio=375/667,isMobile?this.mainSize={width:window.innerWidth,height:window.innerHeight}:this.mainSize={width:window.innerHeight*this.ratio,height:window.innerHeight},this.memberData=e.memberData,this.app=new ScenesManager({width:this.mainSize.width,height:this.mainSize.height,backgroundColor:14474718,autoResize:!0,resolution:2}),this.player={sprite:{},sprite_hover:{},move:1,drink:0,distance:0},this.timer=0,this.bump=new PIXI.extras.Bump,this.tools=new Tools({debug:!production}),this.level={step:10,monster:15,drink:10},this.playing=!1,this.speed=.5*this.level.step,this.maps=[{name:"selectorBg",src:"./images/playBg.jpg"},{name:"playerA",src:"./images/playerA.png"},{name:"playerB",src:"./images/playerB.png"},{name:"playerC",src:"./images/playerC.png"},{name:"playerD",src:"./images/playerD.png"},{name:"playerA-txt",src:"./images/playerA-txt.png"},{name:"playerB-txt",src:"./images/playerB-txt.png"},{name:"playerC-txt",src:"./images/playerC-txt.png"},{name:"playerD-txt",src:"./images/playerD-txt.png"},{name:"playerA-head",src:"./images/playerA-head.png"},{name:"playerB-head",src:"./images/playerB-head.png"},{name:"playerC-head",src:"./images/playerC-head.png"},{name:"playerD-head",src:"./images/playerD-head.png"},{name:"smallplayerA",src:"./images/smallplayerA.json"},{name:"smallplayerA-hover",src:"./images/smallplayerA-hover.json"},{name:"smallplayerB",src:"./images/smallplayerB.json"},{name:"smallplayerB-hover",src:"./images/smallplayerB-hover.json"},{name:"smallplayerC",src:"./images/smallplayerC.json"},{name:"smallplayerC-hover",src:"./images/smallplayerC-hover.json"},{name:"smallplayerD",src:"./images/smallplayerD.json"},{name:"smallplayerD-hover",src:"./images/smallplayerD-hover.json"},{name:"drink",src:"./images/drink.json"},{name:"road",src:"./images/road.jpg"},{name:"monsterA",src:"./images/monsterA.png"},{name:"monsterB",src:"./images/monsterB.png"},{name:"monsterC",src:"./images/monsterC.png"},{name:"monsterD",src:"./images/monsterD.png"},{name:"gameover",src:"./images/gameover.json"},{name:"teachBg",src:"./images/teachBg.jpg"},{name:"teach_1",src:"./images/teach-step1.png"},{name:"teach_2",src:"./images/teach-step2.png"},{name:"teach_3",src:"./images/teach-step3.png"},{name:"play-title",src:"./images/sel-title.png"},{name:"selbtnBg",src:"./images/player-head-Bg.png"},{name:"selbtnBg-hover",src:"./images/player-head-hover.png"},{name:"sel-btn",src:"./images/sel-btn.png"},{name:"score-Bg",src:"./images/score-Bg.png"},{name:"btn-left",src:"./images/btn-left.png"},{name:"btn-right",src:"./images/btn-right.png"},{name:"btn-fast",src:"./images/btn-fast.png"},{name:"btn-start",src:"./images/btn-start.png"},{name:"btn-next",src:"./images/btn-next.png"}],this.teachs=[{id:"step1",src:"teach_1"},{id:"step2",src:"teach_2"},{id:"step3",src:"teach_3"}],this.btns=[{name:"decide",src:"sel-btn"},{name:"btnLeft",src:"btn-left"},{name:"btnRight",src:"btn-right"},{name:"btnFast",src:"btn-fast"},{name:"btnStart",src:"btn-start"},{name:"btnNext",src:"btn-next"}],this.gameItem=[{name:"score",src:"score-Bg"}],this.btnBg=[{src:"./images/player-head-Bg.png",hover:"./images/player-head-hover.png"}],this.plays=[{id:"worker",name:"老油條",intro:"playerA-txt",mainImg:"playerA",head:"smallplayerA",head_hover:"smallplayerA-hover",src:"playerA-head",ignore:"monsterA",gtmData:"遊戲選擇人物頁_老油條"},{id:"ol",name:"厭世上班族",intro:"playerB-txt",mainImg:"playerB",head:"smallplayerB",head_hover:"smallplayerB-hover",src:"playerB-head",ignore:"monsterB",gtmData:"遊戲選擇人物頁_厭世上班族"},{id:"loser",name:"魯宅男大生",intro:"playerC-txt",mainImg:"playerC",head:"smallplayerC",head_hover:"smallplayerC-hover",src:"playerC-head",ignore:"monsterC",gtmData:"遊戲選擇人物頁_魯宅男大生"},{id:"girl",name:"西斯女大生",intro:"playerD-txt",mainImg:"playerD",head:"smallplayerD",head_hover:"smallplayerD-hover",src:"playerD-head",ignore:"monsterD",gtmData:"遊戲選擇人物頁_西斯女大生"}],this.monsters=[{id:"monsterA",name:"慣老闆"},{id:"monsterB",name:"豬隊友"},{id:"monsterC",name:"公主病女孩"},{id:"monsterD",name:"暴怒教授"}],this.api={oldcode:0,ticket:""},this.preload(),this.getToken=function(){return $.ajax({type:"GET",url:"".concat(friendo_url,"auth/login?projectId=66"),headers:{WebToken:"WBqIHc9hTmwyL+g9m0ykfA=="}})},window.onresize=function(){if(window.innerWidth/window.innerHeight>=t.ratio)var e=window.innerHeight*t.ratio,a=window.innerHeight;else e=window.innerWidth,a=window.innerWidth/t.ratio;t.app.renderer.view.style.width=e+"px",t.app.renderer.view.style.height=a+"px"}}return _createClass(a,[{key:"preload",value:function(){var t=this,a=new PIXI.loaders.Loader;this.maps.map(function(e){a.add(e.name,e.src)}),a.on("progress",function(e,a){isMobile?$(".js-bar").css({width:"".concat(Math.ceil(.67*e.progress),"%")}):$(".js-bar").css({width:"".concat(Math.ceil(e.progress),"%")})}),a.load(function(e,a){t.init(),setTimeout(function(){game_view.popup=!1,game_view.popPage=""},100),isMobile?60<=e.progress&&$(".js-bar").css({width:"67%"}):60<=e.progress&&$(".js-bar").css({width:"96%"})})}},{key:"init",value:function(){var t,m=this;m.app.create("game");var e=m.app.createScene("teacharea"),a=m.app.createScene("teacharea2"),r=m.app.createScene("teacharea3"),i=m.app.createScene("selector"),n=m.app.createScene("game"),s=new PIXI.Sprite.from("road"),d=m.mainSize.width/s.width,o=(s.width-180)*d/3,g=[o/2+90*d,3*o/2+90*d,5*o/2+90*d];n.name="mainGame";var l=new PIXI.Container;l.name="loop";var h=new PIXI.Container;h.name="itemLoop";var p=new PIXI.Container;p.name="itemLoop2";var c={row:13,col:3},y=[],v=[],w=PIXI.Sprite.from("selectorBg");650<window.innerHeight?(w.scale.set(.5),w.height=2*window.innerHeight):w.scale.set(.5),i.addChild(w);var f=PIXI.Sprite.from("teachBg");isMobile?(f.width=window.innerWidth,f.height=window.innerHeight):(f.width=m.mainSize.width,f.height=m.mainSize.height),e.addChild(f);var u=new PIXI.Sprite.from("play-title"),C=u.width/u.height;u.width=637,u.height=u.width/C,u.y=84,m.tools.objCenter(u,i,"x"),i.addChild(u);var I=m.playerSet();i.addChild(I);var b=new PIXI.Container;b.name="teachbox",isPc&&(b.width=750,m.tools.objCenter(b,e,"x"),m.tools.objCenter(b,e,"y")),b.width=750,b.height=window.innerHeight,m.tools.objCenter(b,e,"x"),m.tools.objCenter(b,e,"y");var x=m.tools.button({src:m.btns[0].src,fn:function(){game_view.gaEvant("遊戲選擇人物頁_就決定是你"),m.app.goToScene("teacharea"),e.addChild(b),e.addChild(S),e.addChild(_),b.addChild(X)}});x.width=x.width/2,x.height=x.height/2,x.y=window.innerHeight/(m.mainSize.width/750)-x.height-30,m.tools.objCenter(x,i,"x"),i.addChild(x);var _=m.tools.button({src:m.btns[3].src,fn:function(){game_view.gaEvant("遊戲教學頁_跳過教學"),game_view.gaEvant(m.player.gtmData);for(var e=[],a=0;a<2;a++){var t=PIXI.Texture.fromFrame(m.player.head+"-"+(a+1)+".png");e.push(t)}m.player.sprite=new PIXI.extras.AnimatedSprite(e),m.player.sprite.animationSpeed=.05,m.player.sprite.infinite=!0,m.player.sprite.play(),m.player.sprite.scale.set(250/m.player.sprite.height*d),m.player.sprite.anchor.set(.5),m.player.sprite.x=g[1],m.player.sprite.y=m.mainSize.height-145,n.addChildAt(m.player.sprite,3);var r=[];for(a=0;a<2;a++){var i=PIXI.Texture.fromFrame(m.player.head_hover+"-"+(a+1)+".png");r.push(i)}m.player.sprite_hover=new PIXI.extras.AnimatedSprite(r),m.player.sprite_hover.animationSpeed=.05,m.player.sprite_hover.infinite=!0,m.player.sprite_hover.alpha=0,m.player.sprite_hover.play(),m.player.sprite_hover.scale.set(250/m.player.sprite_hover.height*d),m.player.sprite_hover.anchor.set(.5),m.player.sprite_hover.x=g[1],m.player.sprite_hover.y=m.mainSize.height-145,n.addChildAt(m.player.sprite_hover,4),m.app.goToScene("game"),setTimeout(J,500)}});_.name="gotobtn",_.scale.set(60/_.height*d),_.y=30,_.x=e.width-_.width-20;var S=m.tools.button({src:m.btns[5].src,fn:function(){game_view.gaEvant("遊戲教學頁_下一步1"),m.app.goToScene("teacharea2"),b.removeChild(X),a.addChild(f),a.addChild(b),a.addChild(P),a.addChild(_),b.addChild(k)}});S.scale.set(120/S.height*d),S.y=window.innerHeight-S.height-30,m.tools.objCenter(S,e,"x");var P=m.tools.button({src:m.btns[5].src,fn:function(){game_view.gaEvant("遊戲教學頁_下一步2"),m.app.goToScene("teacharea3"),b.removeChild(k),r.addChild(f),r.addChild(b),r.addChild(B),r.addChild(_),b.addChild(A)}});P.scale.set(120/P.height*d),P.y=window.innerHeight-P.height-30,m.tools.objCenter(P,e,"x");var B=m.tools.button({src:m.btns[4].src,fn:function(){game_view.gaEvant("遊戲教學頁_我明白了"),game_view.gaEvant(m.player.gtmData);for(var e=[],a=0;a<2;a++){var t=PIXI.Texture.fromFrame(m.player.head+"-"+(a+1)+".png");e.push(t)}m.player.sprite=new PIXI.extras.AnimatedSprite(e),m.player.sprite.animationSpeed=.05,m.player.sprite.infinite=!0,m.player.sprite.play(),m.player.sprite.scale.set(250/m.player.sprite.height*d),m.player.sprite.anchor.set(.5),m.player.sprite.x=g[1],m.player.sprite.y=m.mainSize.height-145,n.addChildAt(m.player.sprite,3);var r=[];for(a=0;a<2;a++){var i=PIXI.Texture.fromFrame(m.player.head_hover+"-"+(a+1)+".png");r.push(i)}m.player.sprite_hover=new PIXI.extras.AnimatedSprite(r),m.player.sprite_hover.animationSpeed=.05,m.player.sprite_hover.infinite=!0,m.player.sprite_hover.alpha=0,m.player.sprite_hover.play(),m.player.sprite_hover.scale.set(250/m.player.sprite_hover.height*d),m.player.sprite_hover.anchor.set(.5),m.player.sprite_hover.x=g[1],m.player.sprite_hover.y=m.mainSize.height-145,n.addChildAt(m.player.sprite_hover,4),m.app.goToScene("game"),setTimeout(J,500)}});B.scale.set(100/B.height*d),B.y=window.innerHeight-B.height-30,m.tools.objCenter(B,e,"x");var X=new PIXI.Sprite.from(m.teachs[0].src);X.scale.set(600/X.height*d),m.tools.objCenter(X,b,"x"),m.tools.objCenter(X,b,"y"),X.y-=30;var k=new PIXI.Sprite.from(m.teachs[1].src);k.scale.set(600/k.height*d),m.tools.objCenter(k,b,"x"),m.tools.objCenter(k,b,"y"),k.y-=30;var A=new PIXI.Sprite.from(m.teachs[2].src);A.scale.set(700/A.height*d),m.tools.objCenter(A,b,"x"),m.tools.objCenter(A,b,"y"),A.y-=30;var j=new PIXI.Sprite.from("road");j.y=1-j.height,s.y=0,l.scale.set(d),l.addChild(s,j),U(h),U(p),h.y=-h.height,p.y=-p.height-h.height-30;var D=new PIXI.Container;D.name="contorls";var z=m.tools.button({src:m.btns[1].src,fn:R("left")});z.scale.set(200/z.height*d),z.x=0,z.y=m.mainSize.height-z.height-50;var T=m.tools.button({src:m.btns[2].src,fn:R("right")});T.scale.set(200/T.height*d),T.x=m.mainSize.width-T.width,T.y=m.mainSize.height-T.height-50;var M=new PIXI.Container,H=new PIXI.Sprite.from(m.gameItem[0].src);H.scale.set(180/H.height*d);var E=new PIXI.Text("0",{fontFamily:"Arial",fontSize:30,fill:16777215,align:"center"});E.x=70*d,E.y=H.height-E.height-20,M.addChild(H,E),M.x=m.mainSize.width-M.width-10,M.y=10;var F=new PIXI.Text(m.timer,{fontFamily:"Arial",fontSize:24,fill:16741989,align:"center"});F.x=200,F.y=40,D.addChild(z,T,M);var L=new PIXI.Container,N=m.tools.graphic({color:0,x:0,y:0,width:m.mainSize.width,height:m.mainSize.height});N.alpha=.6;for(var O=[],W=0;W<8;W++){var G=PIXI.Texture.fromFrame("gameover-"+(W+1)+".png");O.push(G)}var $=new PIXI.extras.AnimatedSprite(O);$.animationSpeed=.08,$.infinite=!0,$.play(),$.scale.set(.4),$.anchor.set(.5),$.x=m.mainSize.width/2,$.y=m.mainSize.height/2,L.addChild(N,$);var V=new TimelineLite({paused:!0});function R(a){return function(){return new Promise(function(e){if(m.playing){switch(a){case"left":0!=m.player.move&&(m.player.move--,m.player.sprite.x=g[m.player.move],m.player.sprite_hover.x=g[m.player.move],game_view.gaEvant("遊戲進行頁_左鍵"));break;case"right":2!=m.player.move&&(m.player.move++,m.player.sprite.x=g[m.player.move],m.player.sprite_hover.x=g[m.player.move],game_view.gaEvant("遊戲進行頁_右鍵"))}e()}else e()})}}function q(){s.y+=m.tools.guiData.speed,j.y+=m.tools.guiData.speed,F.text=m.timer,m.player.distance+=Math.floor(m.tools.guiData.speed),E.text=parseInt(E.text)+Math.floor(m.tools.guiData.speed),m.tools.guiData.speed=.5*(Math.floor(m.timer/5)+m.level.step),s.y>=m.mainSize.height/d&&(s.y=1-s.height),j.y>=m.mainSize.height/d&&(j.y=1-j.height)}function K(){if(h.y+=m.tools.guiData.speed,h.y>=m.mainSize.height/d){for(;h.children[0];){h.removeChild(h.children[0]),-1<(e=v.indexOf(h.children[0]))&&v.splice(e,1),-1<(e=y.indexOf(h.children[0]))&&y.splice(e,1)}U(h),h.y=p.y-h.height-600}if(p.y>=m.mainSize.height/d){for(;p.children[0];){var e;p.removeChild(p.children[0]),-1<(e=v.indexOf(p.children[0]))&&v.splice(e,1),-1<(e=y.indexOf(p.children[0]))&&y.splice(e,1)}U(p),p.y=h.y-p.height-300}else p.y+=m.tools.guiData.speed;m.bump.hit(m.player.sprite,y,!1,!1,!0,function(e,a){a.name!=m.player.ignore&&function(){m.playing=!1,m.player.sprite.stop(),clearInterval(t),m.app.ticker.remove(K),m.app.ticker.remove(q),V.play(),game_view.gamePage="grade",$.stop();m.api.oldcode,m.timer,m.player.distance,m.player.drink;game_view.person.score=E.text,game_view.gcode=E.text,game_view.top100Api()}()}),m.bump.hit(m.player.sprite,v,!1,!1,!0,function(e,a){a.alpha=0;var t=new TimelineMax({repeat:1});t.to(m.player.sprite_hover,.1,{alpha:1}),t.to(m.player.sprite_hover,.1,{alpha:0});var r=v.indexOf(a);v.splice(r,1),E.text=parseInt(E.text)+3e3,m.player.drink++})}function U(e){for(var a=0,t=0;t<c.row*c.col;t++){var r=Math.floor(4*Math.random()),i=m.monsters[r],n=100*Math.random()<=m.level.monster;if(n||(a=0),100*Math.random()<=m.level.drink||0==t||t==c.row*c.col-1){for(var s=[],o=a=0;o<2;o++){var l=PIXI.Texture.fromFrame("drink-"+(o+1)+".png");s.push(l)}var h=new PIXI.extras.AnimatedSprite(s);h.name="drink"+t,h.animationSpeed=.08,h.infinite=!0,h.play(),h.scale.set(220/h.height*d),h.anchor.set(.5,0),h.x=g[t%3],h.y=350*Math.floor(t/3),v.push(h),e.addChild(h)}else if(n&&++a<=2){var p=new PIXI.Sprite.from(i.id);p.name=i.id,p.scale.set(200/p.height*d),p.anchor.set(.5,0),p.x=g[t%3],p.y=350*Math.floor(t/3),y.push(p),e.addChild(p)}}}function J(){m.playing=!0,t=setInterval(function(){m.timer++},1e3),m.app.ticker.add(q),m.app.ticker.add(K);var e=m.player.head.substr(-1);"A"==e&&(game_view.fbslink="https://result.friendo.com.tw/kzOwL"),"B"==e&&(game_view.fbslink="https://result.friendo.com.tw/gzh7C"),"C"==e&&(game_view.fbslink="https://result.friendo.com.tw/0pXUW"),"D"==e&&(game_view.fbslink="https://result.friendo.com.tw/GKIOV")}V.from(L,.5,{alpha:0}),m.tools.addGui("speed",{type:"number",setVal:m.speed,min:1,max:100}),m.tools.addGui("stop",{setVal:function(){m.app.ticker.remove(K),m.app.ticker.remove(q)}}),m.tools.addGui("start",{setVal:function(){setInterval(function(){m.timer++},1e3),m.app.ticker.add(q),m.app.ticker.add(K)}}),n.addChild(l,h,p,D,L),i.scale.set(m.mainSize.width/750),m.app.goToScene("selector")}},{key:"playerSet",value:function(){var g=this,c=new PIXI.Container;c.name="playerBox";var s=new PIXI.Container;function o(e){var d=e;return function(){var m=d;return new Promise(function(e,a){g.player=g.plays[m],g.player.move=1,g.player.drink=0,g.player.distance=0;var t=g.app.getScene("selector"),r=new TimelineLite({onComplete:function(){return e(!0)}});if(t.getChildByName("playerBox")){var i=t.getChildByName("playerBox"),n=i.getChildByName("pIntro"),s=i.getChildByName("pImg");r.add(TweenMax.to([n,s],.2,{alpha:0,onComplete:function(){i.removeChild(n,s)}}))}var o=new PIXI.Sprite.from(g.player.intro);o.name="pIntro",o.width=336,o.height=549,o.y=window.innerHeight-100,o.x=45,isMobile||(o.y=519);var l=new PIXI.Sprite.from(g.player.mainImg);l.name="pImg",l.anchor.set(1,1),l.x=750,l.y=1334,l.width=l.width/2,l.height=l.height/2,800<window.innerHeight&&(l.y=1600),isMobile||(l.y=1334),c.addChild(o),c.addChild(l);var h=c.getChildByName("selcharAll").children,p=[];h.map(function(e){p.push(TweenMax.to(e.getChildByName("btnhover"),.1,{alpha:0}))}),r.add(p),r.add([TweenMax.to(h[d].getChildByName("btnhover"),.1,{alpha:1}),TweenMax.from([o,l],.1,{alpha:0})]),r.play()})}}return s.name="selcharAll",s.x=52,s.y=157,g.plays.forEach(function(e,a){var t=g.tools.button({src:e.src,fn:o(a)});t.width,t.height;t.name="selchar",t.width=155.5,t.height=271;var r=new PIXI.Container;r.name="selbox",r.width=155.5,r.height=271,r.x=160*a;var i=new PIXI.Sprite.from("./images/player-head-Bg.png");i.name="btnBg",i.width=155.5,i.height=271;var n=new PIXI.Sprite.from("./images/player-head-hover.png");n.name="btnhover",n.width=155.5,n.height=271,n.alpha=0,s.addChild(r),r.addChild(i),r.addChild(n),r.addChild(t)}),c.addChild(s),o(0)(),c}}]),a}();